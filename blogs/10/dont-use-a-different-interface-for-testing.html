<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Komu W - Don't use a different interface in tests.</title>
    <meta name="description" content="Don't use a different interface in tests." />
    <meta property="og:url" content="https://www.komu.engineer/blog" />

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ADD FAVICON -->

    <link rel="stylesheet" href="../../site.css">

    <!-- Get highlightjs by going to https://highlightjs.org/download/, select the languages you want and download. -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/styles/default.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>
</head>

<body>
    <div class="container">
        <div class="header">
            <a href="https://www.komu.engineer">Home</a>&nbsp;&nbsp;
            <a href="https://www.komu.engineer/about">About Me</a>&nbsp;&nbsp;
            <a href="https://www.komu.engineer/blog">Blog</a>&nbsp;&nbsp;
        </div>
        <div class="left-sidebar">
            .
        </div>
        <div class="right-sidebar">
            .
        </div>

        <div class="main">
            <p>
                </br>
                <strong>Don't use a different interface in tests. (05 May 2022)</strong>
                </br>
                // TODO: remove these ordered lists.
            <ol>
                <li><a href="#Problem">Problem</a></li>
                <li> <a href="#Solution">Proposed Solution</a></li>
                <li> <a href="#Conclusion">Conclusion</a></li>
            </ol>

            This is probably going to be an unpopular opinion, but;</br>
            Your test code should not be using a different interface implementation compared to your non test code.</br>
            Using different implementations(sometimes called 'mocking') is one of the best ways you can lie to yourself
            that you are testing your code whereas you really aren't.</br></br>

            An example will suffice to drive my point. Let's say we have created a library meant to be used in logging.
            The library has one that takes an <i>io.Writer</i> and a message to log.
            <pre><code class="go">
// logg writes msg to the data stream provided by w
func logg(w io.Writer, msg string) error {
    msg = msg + "\n"
    _, err := w.Write([]byte(msg))
    return err
}
            </code></pre>
            And the way we use it in our application(ie non-test code) is;
            <pre><code class="go">
// httpLogger logs messages to a HTTP logging service
type httpLogger struct{}

// Write fulfills io.Writer interface
func (h httpLogger) Write(p []byte) (n int, err error) {
    tr := &http.Transport{
        MaxIdleConns:       10,
        IdleConnTimeout:    10 * time.Second,
        DisableCompression: true,
    }
    maxOfThreeRedirects := func(req *http.Request, via []*http.Request) error {
        max := 3
        if req.Header.Get("Auth") != "" {
            // requests that have set Auth header can follow more redirects.
            max = 12
        }
        if len(via) >= max {
            return fmt.Errorf("stopped after %d redirects", max)
        }
        return nil
    }
    client := &http.Client{
        Transport:     tr,
        Timeout:       10 * time.Second,
        CheckRedirect: maxOfThreeRedirects,
    }
    resp, err := client.Post("https://httpbin.org/post", "application/json", bytes.NewReader(p))
    return int(resp.Request.ContentLength), err
}

func main() {
	err := logg(httpLogger{}, "hey-httpLogger")
	if err != nil {
		log.Fatal(err)
	}
}
            </code></pre>
            At this point, we would like to write tests to
        </div>
    </div>
</body>